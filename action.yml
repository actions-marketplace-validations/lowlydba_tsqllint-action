name: "TSQLLint Action"
author: "lowlydba"
description: "Lint T-SQL files using TSQLLint"
branding:
  icon: "check-circle"
  color: "green"
inputs:
  path:
    description: "Space delimited path(s) to run linter against. Wildcards can be specified using `*`."
    required: false
    default: "."
  config:
    description: "Path to a configuration file for the linter."
    required: false
  comment:
    description: "Create comment with summary of linter results."
    required: false
    default: "false"
runs:
  using: composite
  steps:
    - name: Install TSQLLint
      run: |
        yarn global add tsqllint > /dev/null 2>&1
      shell: bash -e {0}

    - name: Run TSQLLint
      run: |
        tsqllint -p -c "${{ inputs.config }}" | tail -1
        tsqllint -v | tail -1
        tsqllint "${{ inputs.path }}" -c "${{ inputs.config }}" > .tsqllint-output || true
        cat .tsqllint-output
      shell: bash -e {0}

    - name: Generate comment
      if: contains(inputs.comment, 'true')
      run: |
        warnings=`cat .tsqllint-output | tail -1`
        errors=`cat .tsqllint-output | tail -2 | head -1`
        export TSQLLINT_PASS="false"
        if [[ ${warnings:0:1} == "0" && ${errors:0:1} == "0" ]] || [ $warnings == "running tsqllint" ]; then TSQLLINT_PASS="true"; fi
        if [[ $TSQLLINT_PASS == "true" ]]; then status=":white_check_mark:"; else status=":x:"; fi
        echo -e "## $status TSQLLint Summary\n" >> .tsqllint-output.final
        if [[ $TSQLLINT_PASS != "true" ]]; then cat .tsqllint-output | tail -4 >> .tsqllint-output.final; else echo "No issues found." >> .tsqllint-output.final; fi
        echo -e "\nResults for commit ${{ github.sha }}." >> .tsqllint-output.final
        echo -e "\n[Detailed results.]($GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID)" >> .tsqllint-output.final
        echo -e "\n:recycle: This comment has been updated with latest results." >> .tsqllint-output.final
      shell: bash -e {0}

    - name: Post as comment
      if: contains(inputs.comment, 'true')
      uses: marocchino/sticky-pull-request-comment@v2
      with:
        path: .tsqllint-output.final

    - name: Final check status
      if: contains(env.TSQLLINT_PASS, 'false')
      run: |
        exit 1;
      shell: bash
